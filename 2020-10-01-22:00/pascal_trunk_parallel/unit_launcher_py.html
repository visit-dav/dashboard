<html><body bgcolor="#e0e0e0"><head><title>unit/launcher.py</title></head><pre><font face="Lucida,Courier New"><font color="#a02030"># ----------------------------------------------------------------------------</font>
<font color="#a02030">#  CLASSES: nightly</font>
<font color="#a02030">#</font>
<font color="#a02030">#  Test Case:  launcher.py</font>
<font color="#a02030">#</font>
<font color="#a02030">#  Tests:      This script tests internallauncher's transformation of visit</font>
<font color="#a02030">#              command line arguments into parallel launch arguments.</font>
<font color="#a02030">#</font>
<font color="#a02030">#  Brad Whitlock, Tue Sep 11 12:31:34 PDT 2012</font>
<font color="#a02030">#</font>
<font color="#a02030"># Modifications:</font>
<font color="#a02030">#   Brad Whitlock, Fri Dec  7 09:08:22 PST 2012</font>
<font color="#a02030">#   I added a little more filtering of the launcher output to replace the host</font>
<font color="#a02030">#   with $HOST now that the noloopback case will always use the real host</font>
<font color="#a02030">#   name instead of 127.0.0.1 for parallel engine launches.</font>
<font color="#a02030">#</font>
<font color="#a02030"># ----------------------------------------------------------------------------</font>
<font color="#C00000">import</font> <font color="#000000">os</font>
<font color="#C00000">import</font> <font color="#000000">socket</font>
<font color="#C00000">import</font> <font color="#000000">subprocess</font>
<font color="#C00000">import</font> <font color="#000000">getpass</font>

<font color="#a02030"># The launch cases we want to test.</font>
<font color="#000000">launch_cases</font> <font color="#4000C0">=</font> <font color="#4000C0">{</font>
<font color="#008000">"aprun"</font>          <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-nn"</font><font color="#4000C0">,</font> <font color="#008000">"1"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"bsub"</font>           <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-p"</font><font color="#4000C0">,</font> <font color="#008000">"pbatch"</font><font color="#4000C0">,</font> <font color="#008000">"-t"</font><font color="#4000C0">,</font> <font color="#008000">"30:00"</font><font color="#4000C0">,</font> <font color="#008000">"-la"</font><font color="#4000C0">,</font> <font color="#008000">"-arg1 -arg2"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"bsub/mpirun"</font>    <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-p"</font><font color="#4000C0">,</font> <font color="#008000">"pbatch"</font><font color="#4000C0">,</font> <font color="#008000">"-t"</font><font color="#4000C0">,</font> <font color="#008000">"30:00"</font><font color="#4000C0">,</font> <font color="#008000">"-la"</font><font color="#4000C0">,</font> <font color="#008000">"-arg1 -arg2"</font><font color="#4000C0">,</font> <font color="#008000">"-sla"</font><font color="#4000C0">,</font> <font color="#008000">"-arg3 -arg4"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"dmpirun"</font>        <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-b"</font><font color="#4000C0">,</font> <font color="#008000">"bdivp"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"ibrun"</font>          <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"mpirun"</font>         <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"msub/aprun"</font>     <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-nn"</font><font color="#4000C0">,</font> <font color="#008000">"1"</font><font color="#4000C0">,</font> <font color="#008000">"-sla"</font><font color="#4000C0">,</font> <font color="#008000">"-arg1 -arg2"</font><font color="#4000C0">,</font> <font color="#008000">"-hw-pre"</font><font color="#4000C0">,</font> <font color="#008000">"startx"</font><font color="#4000C0">,</font> <font color="#008000">"-hw-post"</font><font color="#4000C0">,</font> <font color="#008000">"stopx"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"msub/ibrun"</font>     <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-hw-pre"</font><font color="#4000C0">,</font> <font color="#008000">"startx"</font><font color="#4000C0">,</font> <font color="#008000">"-hw-post"</font><font color="#4000C0">,</font> <font color="#008000">"stopx"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"msub/mpiexec"</font>   <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-slpre"</font><font color="#4000C0">,</font> <font color="#008000">"echo 'slprecommand'"</font><font color="#4000C0">,</font> <font color="#008000">"-slpost"</font><font color="#4000C0">,</font> <font color="#008000">"echo 'slpostcommand'"</font><font color="#4000C0">,</font> <font color="#008000">"-sla"</font><font color="#4000C0">,</font> <font color="#008000">"-arg1 -arg2"</font><font color="#4000C0">,</font> <font color="#008000">"-machinefile"</font><font color="#4000C0">,</font> <font color="#008000">"machine.txt"</font><font color="#4000C0">,</font> <font color="#008000">"-hw-pre"</font><font color="#4000C0">,</font> <font color="#008000">"startx"</font><font color="#4000C0">,</font> <font color="#008000">"-hw-post"</font><font color="#4000C0">,</font> <font color="#008000">"stopx"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"msub/mpirun"</font>    <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-sla"</font><font color="#4000C0">,</font> <font color="#008000">"-arg1 -arg2"</font><font color="#4000C0">,</font> <font color="#008000">"-machinefile"</font><font color="#4000C0">,</font> <font color="#008000">"machine.txt"</font><font color="#4000C0">,</font> <font color="#008000">"-hw-pre"</font><font color="#4000C0">,</font> <font color="#008000">"startx"</font><font color="#4000C0">,</font> <font color="#008000">"-hw-post"</font><font color="#4000C0">,</font> <font color="#008000">"stopx"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"msub/srun"</font>      <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-sla"</font><font color="#4000C0">,</font> <font color="#008000">"-arg1 -arg2"</font><font color="#4000C0">,</font> <font color="#008000">"-hw-pre"</font><font color="#4000C0">,</font> <font color="#008000">"startx"</font><font color="#4000C0">,</font> <font color="#008000">"-hw-post"</font><font color="#4000C0">,</font> <font color="#008000">"stopx"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"poe"</font>            <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-nn"</font><font color="#4000C0">,</font> <font color="#008000">"1"</font><font color="#4000C0">,</font> <font color="#008000">"-p"</font><font color="#4000C0">,</font> <font color="#008000">"pbatch"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"prun"</font>           <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-nn"</font><font color="#4000C0">,</font> <font color="#008000">"1"</font><font color="#4000C0">,</font> <font color="#008000">"-p"</font><font color="#4000C0">,</font> <font color="#008000">"pbatch"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"psub"</font>           <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-n"</font><font color="#4000C0">,</font> <font color="#008000">"JOB_NAME"</font><font color="#4000C0">,</font> <font color="#008000">"-p"</font><font color="#4000C0">,</font> <font color="#008000">"pbatch"</font><font color="#4000C0">,</font> <font color="#008000">"-b"</font><font color="#4000C0">,</font> <font color="#008000">"bdivp"</font><font color="#4000C0">,</font> <font color="#008000">"-t"</font><font color="#4000C0">,</font> <font color="#008000">"30:00"</font><font color="#4000C0">,</font> <font color="#008000">"-expedite"</font><font color="#4000C0">,</font> <font color="#008000">"-slpre"</font><font color="#4000C0">,</font> <font color="#008000">"echo 'pre command'"</font><font color="#4000C0">,</font> <font color="#008000">"-slpost"</font><font color="#4000C0">,</font> <font color="#008000">"echo 'post command'"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"psub/mpirun"</font>    <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-nn"</font><font color="#4000C0">,</font> <font color="#008000">"1"</font><font color="#4000C0">,</font> <font color="#008000">"-n"</font><font color="#4000C0">,</font> <font color="#008000">"JOB_NAME"</font><font color="#4000C0">,</font> <font color="#008000">"-p"</font><font color="#4000C0">,</font> <font color="#008000">"pbatch"</font><font color="#4000C0">,</font> <font color="#008000">"-b"</font><font color="#4000C0">,</font> <font color="#008000">"bdivp"</font><font color="#4000C0">,</font> <font color="#008000">"-t"</font><font color="#4000C0">,</font> <font color="#008000">"30:00"</font><font color="#4000C0">,</font> <font color="#008000">"-expedite"</font><font color="#4000C0">,</font> <font color="#008000">"-slpre"</font><font color="#4000C0">,</font> <font color="#008000">"echo 'pre command'"</font><font color="#4000C0">,</font> <font color="#008000">"-slpost"</font><font color="#4000C0">,</font> <font color="#008000">"echo 'post command'"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"psub/srun"</font>      <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-nn"</font><font color="#4000C0">,</font> <font color="#008000">"1"</font><font color="#4000C0">,</font> <font color="#008000">"-n"</font><font color="#4000C0">,</font> <font color="#008000">"JOB_NAME"</font><font color="#4000C0">,</font> <font color="#008000">"-p"</font><font color="#4000C0">,</font> <font color="#008000">"pbatch"</font><font color="#4000C0">,</font> <font color="#008000">"-b"</font><font color="#4000C0">,</font> <font color="#008000">"bdivp"</font><font color="#4000C0">,</font> <font color="#008000">"-t"</font><font color="#4000C0">,</font> <font color="#008000">"30:00"</font><font color="#4000C0">,</font> <font color="#008000">"-expedite"</font><font color="#4000C0">,</font> <font color="#008000">"-slpre"</font><font color="#4000C0">,</font> <font color="#008000">"echo 'pre command'"</font><font color="#4000C0">,</font> <font color="#008000">"-slpost"</font><font color="#4000C0">,</font> <font color="#008000">"echo 'post command'"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>


<font color="#008000">"salloc"</font>         <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-p"</font><font color="#4000C0">,</font> <font color="#008000">"pbatch"</font><font color="#4000C0">,</font> <font color="#008000">"-t"</font><font color="#4000C0">,</font> <font color="#008000">"30:00"</font><font color="#4000C0">,</font> <font color="#008000">"-nn"</font><font color="#4000C0">,</font> <font color="#008000">"1"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"sbatch"</font>         <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-p"</font><font color="#4000C0">,</font> <font color="#008000">"pbatch"</font><font color="#4000C0">,</font> <font color="#008000">"-b"</font><font color="#4000C0">,</font> <font color="#008000">"bdivp"</font><font color="#4000C0">,</font> <font color="#008000">"-nn"</font><font color="#4000C0">,</font> <font color="#008000">"1"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"sbatch/aprun"</font>   <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-p"</font><font color="#4000C0">,</font> <font color="#008000">"pbatch"</font><font color="#4000C0">,</font> <font color="#008000">"-b"</font><font color="#4000C0">,</font> <font color="#008000">"bdivp"</font><font color="#4000C0">,</font> <font color="#008000">"-nn"</font><font color="#4000C0">,</font> <font color="#008000">"1"</font><font color="#4000C0">,</font> <font color="#008000">"-sla"</font><font color="#4000C0">,</font> <font color="#008000">"-arg1 -arg2"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"srun"</font>           <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#008000">"-nn"</font><font color="#4000C0">,</font> <font color="#008000">"1"</font><font color="#4000C0">,</font> <font color="#008000">"-p"</font><font color="#4000C0">,</font> <font color="#008000">"pbatch"</font><font color="#4000C0">,</font> <font color="#008000">"-b"</font><font color="#4000C0">,</font> <font color="#008000">"bdivp"</font><font color="#4000C0">,</font> <font color="#008000">"-n"</font><font color="#4000C0">,</font> <font color="#008000">"JOB_NAME"</font><font color="#4000C0">,</font> <font color="#008000">"-t"</font><font color="#4000C0">,</font> <font color="#008000">"30:00"</font><font color="#4000C0">]</font><font color="#4000C0">,</font>
<font color="#008000">"yod"</font>            <font color="#4000C0">:</font> <font color="#4000C0">[</font><font color="#4000C0">]</font><font color="#4000C0">}</font>

<font color="#a02030"># Some debugger arguments.</font>
<font color="#000000">debuggers</font> <font color="#4000C0">=</font> <font color="#4000C0">[</font><font color="#4000C0">[</font><font color="#4000C0">]</font><font color="#4000C0">,</font> <font color="#4000C0">[</font><font color="#008000">"-totalview"</font><font color="#4000C0">,</font> <font color="#008000">"engine_par"</font><font color="#4000C0">]</font><font color="#4000C0">,</font> <font color="#4000C0">[</font><font color="#008000">"-valgrind"</font><font color="#4000C0">,</font> <font color="#008000">"engine_par"</font><font color="#4000C0">]</font><font color="#4000C0">,</font> <font color="#4000C0">[</font><font color="#008000">"-strace"</font><font color="#4000C0">,</font> <font color="#008000">"engine_par"</font><font color="#4000C0">]</font><font color="#4000C0">]</font>

<font color="#a02030"># Get the launcher command for new versions of VisIt.</font>
<font color="#C00000">def</font> <font color="#000000">GetLauncherCommand</font><font color="#4000C0">(</font><font color="#000000">args</font><font color="#4000C0">)</font><font color="#4000C0">:</font>
    <font color="#000000">p</font> <font color="#4000C0">=</font> <font color="#000000">subprocess</font><font color="#4000C0">.</font><font color="#000000">Popen</font><font color="#4000C0">(</font><font color="#000000">args</font><font color="#4000C0">,</font> <font color="#000000">stdin</font><font color="#4000C0">=</font><font color="#000000">subprocess</font><font color="#4000C0">.</font><font color="#000000">PIPE</font><font color="#4000C0">,</font> <font color="#000000">stdout</font><font color="#4000C0">=</font><font color="#000000">subprocess</font><font color="#4000C0">.</font><font color="#000000">PIPE</font><font color="#4000C0">,</font> <font color="#000000">stderr</font><font color="#4000C0">=</font><font color="#000000">subprocess</font><font color="#4000C0">.</font><font color="#000000">PIPE</font><font color="#4000C0">)</font>
    <font color="#000000">stdout</font><font color="#4000C0">,</font> <font color="#000000">stderr</font> <font color="#4000C0">=</font> <font color="#000000">p</font><font color="#4000C0">.</font><font color="#000000">communicate</font><font color="#4000C0">(</font><font color="#4000C0">)</font>
    <font color="#000000">ru</font> <font color="#4000C0">=</font> <font color="#000000">stdout</font><font color="#4000C0">.</font><font color="#000000">find</font><font color="#4000C0">(</font><font color="#008000">"RUN USING"</font><font color="#4000C0">)</font>
    <font color="#C00000">if</font> <font color="#000000">ru</font> <font color="#4000C0">!=</font> <font color="#4000C0">-</font><font color="#0080C0">1</font><font color="#4000C0">:</font>
        <font color="#000000">cmd</font> <font color="#4000C0">=</font> <font color="#000000">stdout</font><font color="#4000C0">[</font><font color="#000000">ru</font> <font color="#4000C0">+</font> <font color="#0080C0">11</font><font color="#4000C0">:</font><font color="#4000C0">-</font><font color="#0080C0">2</font><font color="#4000C0">]</font>
    <font color="#C00000">else</font><font color="#4000C0">:</font>
        <font color="#000000">cmd</font> <font color="#4000C0">=</font> <font color="#000000">stdout</font>
    <font color="#C00000">return</font> <font color="#000000">cmd</font>

<font color="#C00000">def</font> <font color="#000000">FilterLauncherOutput</font><font color="#4000C0">(</font><font color="#000000">text</font><font color="#4000C0">,</font> <font color="#000000">replacements</font><font color="#4000C0">)</font><font color="#4000C0">:</font>
    <font color="#C00000">for</font> <font color="#000000">k</font> <font color="#C00000">in</font> <font color="#000000">list</font><font color="#4000C0">(</font><font color="#000000">replacements</font><font color="#4000C0">.</font><font color="#000000">keys</font><font color="#4000C0">(</font><font color="#4000C0">)</font><font color="#4000C0">)</font><font color="#4000C0">:</font>
        <font color="#000000">text</font> <font color="#4000C0">=</font> <font color="#000000">string</font><font color="#4000C0">.</font><font color="#000000">replace</font><font color="#4000C0">(</font><font color="#000000">text</font><font color="#4000C0">,</font> <font color="#000000">k</font><font color="#4000C0">,</font> <font color="#000000">replacements</font><font color="#4000C0">[</font><font color="#000000">k</font><font color="#4000C0">]</font><font color="#4000C0">)</font>
    <font color="#C00000">return</font> <font color="#000000">text</font>

<font color="#C00000">def</font> <font color="#000000">FilterHostName</font><font color="#4000C0">(</font><font color="#000000">text</font><font color="#4000C0">)</font><font color="#4000C0">:</font>
    <font color="#000000">host</font> <font color="#4000C0">=</font> <font color="#000000">string</font><font color="#4000C0">.</font><font color="#000000">find</font><font color="#4000C0">(</font><font color="#000000">text</font><font color="#4000C0">,</font> <font color="#008000">"-host"</font><font color="#4000C0">)</font>
    <font color="#000000">port</font> <font color="#4000C0">=</font> <font color="#000000">string</font><font color="#4000C0">.</font><font color="#000000">find</font><font color="#4000C0">(</font><font color="#000000">text</font><font color="#4000C0">,</font> <font color="#008000">"-port"</font><font color="#4000C0">)</font>
    <font color="#C00000">if</font> <font color="#000000">host</font> <font color="#4000C0">!=</font> <font color="#4000C0">-</font><font color="#0080C0">1</font> <font color="#C00000">and</font> <font color="#000000">port</font> <font color="#4000C0">!=</font> <font color="#4000C0">-</font><font color="#0080C0">1</font><font color="#4000C0">:</font>
        <font color="#C00000">return</font> <font color="#000000">text</font><font color="#4000C0">[</font><font color="#4000C0">:</font><font color="#000000">host</font> <font color="#4000C0">+</font> <font color="#0080C0">6</font><font color="#4000C0">]</font> <font color="#4000C0">+</font> <font color="#008000">"$HOST "</font> <font color="#4000C0">+</font> <font color="#000000">text</font><font color="#4000C0">[</font><font color="#000000">port</font><font color="#4000C0">:</font><font color="#4000C0">]</font>
    <font color="#C00000">return</font> <font color="#000000">text</font>

<font color="#C00000">def</font> <font color="#000000">hostname</font><font color="#4000C0">(</font><font color="#4000C0">)</font><font color="#4000C0">:</font>
    <font color="#C00000">return</font> <font color="#000000">socket</font><font color="#4000C0">.</font><font color="#000000">gethostname</font><font color="#4000C0">(</font><font color="#4000C0">)</font>

<font color="#C00000">def</font> <font color="#000000">nodename</font><font color="#4000C0">(</font><font color="#4000C0">)</font><font color="#4000C0">:</font>
    <font color="#C00000">return</font> <font color="#000000">hostname</font><font color="#4000C0">(</font><font color="#4000C0">)</font><font color="#4000C0">.</font><font color="#000000">split</font><font color="#4000C0">(</font><font color="#008000">"."</font><font color="#4000C0">)</font><font color="#4000C0">[</font><font color="#0080C0">0</font><font color="#4000C0">]</font>

<font color="#C00000">def</font> <font color="#000000">sectorname</font><font color="#4000C0">(</font><font color="#4000C0">)</font><font color="#4000C0">:</font>
    <font color="#000000">s</font> <font color="#4000C0">=</font> <font color="#000000">nodename</font><font color="#4000C0">(</font><font color="#4000C0">)</font>
    <font color="#C00000">for</font> <font color="#000000">d</font> <font color="#C00000">in</font> <font color="#008000">"0123456789"</font><font color="#4000C0">:</font>
        <font color="#000000">s</font> <font color="#4000C0">=</font> <font color="#000000">string</font><font color="#4000C0">.</font><font color="#000000">replace</font><font color="#4000C0">(</font><font color="#000000">s</font><font color="#4000C0">,</font> <font color="#000000">d</font><font color="#4000C0">,</font> <font color="#008000">""</font><font color="#4000C0">)</font>
    <font color="#C00000">return</font> <font color="#000000">s</font>

<font color="#C00000">def</font> <font color="#000000">FormatLauncherOutput</font><font color="#4000C0">(</font><font color="#000000">cmd</font><font color="#4000C0">)</font><font color="#4000C0">:</font>
    <font color="#000000">tmpvisit</font> <font color="#4000C0">=</font> <font color="#000000">string</font><font color="#4000C0">.</font><font color="#000000">find</font><font color="#4000C0">(</font><font color="#000000">cmd</font><font color="#4000C0">,</font> <font color="#008000">"/tmp/visit"</font><font color="#4000C0">)</font>
    <font color="#000000">text</font> <font color="#4000C0">=</font> <font color="#008000">""</font>
    <font color="#C00000">if</font> <font color="#000000">tmpvisit</font> <font color="#4000C0">==</font> <font color="#4000C0">-</font><font color="#0080C0">1</font><font color="#4000C0">:</font>
        <font color="#000000">text</font> <font color="#4000C0">=</font> <font color="#000000">cmd</font>
    <font color="#C00000">else</font><font color="#4000C0">:</font>
        <font color="#a02030"># The launcher made a script. Get the contents of the script.</font>
        <font color="#000000">index</font> <font color="#4000C0">=</font> <font color="#000000">tmpvisit</font>
        <font color="#C00000">try</font><font color="#4000C0">:</font>
            <font color="#C00000">while</font> <font color="#000000">cmd</font><font color="#4000C0">[</font><font color="#000000">index</font><font color="#4000C0">]</font> <font color="#4000C0">!=</font> <font color="#008000">'\n'</font><font color="#4000C0">:</font>
                <font color="#000000">index</font> <font color="#4000C0">=</font> <font color="#000000">index</font> <font color="#4000C0">+</font> <font color="#0080C0">1</font>
            <font color="#000000">filename</font> <font color="#4000C0">=</font> <font color="#000000">cmd</font><font color="#4000C0">[</font><font color="#000000">tmpvisit</font><font color="#4000C0">:</font><font color="#000000">index</font><font color="#4000C0">]</font>
        <font color="#C00000">except</font><font color="#4000C0">:</font>
            <font color="#000000">filename</font> <font color="#4000C0">=</font> <font color="#000000">cmd</font><font color="#4000C0">[</font><font color="#000000">tmpvisit</font><font color="#4000C0">:</font><font color="#4000C0">]</font>

        <font color="#000000">cmd</font> <font color="#4000C0">=</font> <font color="#000000">string</font><font color="#4000C0">.</font><font color="#000000">replace</font><font color="#4000C0">(</font><font color="#000000">cmd</font><font color="#4000C0">,</font> <font color="#000000">filename</font><font color="#4000C0">,</font> <font color="#008000">"$LAUNCHSCRIPT"</font><font color="#4000C0">)</font>
        <font color="#000000">text</font> <font color="#4000C0">=</font> <font color="#000000">text</font> <font color="#4000C0">+</font> <font color="#000000">cmd</font>

        <font color="#C00000">try</font><font color="#4000C0">:</font>
            <font color="#000000">lines</font> <font color="#4000C0">=</font> <font color="#000000">open</font><font color="#4000C0">(</font><font color="#000000">filename</font><font color="#4000C0">,</font> <font color="#008000">"rt"</font><font color="#4000C0">)</font><font color="#4000C0">.</font><font color="#000000">readlines</font><font color="#4000C0">(</font><font color="#4000C0">)</font>
            <font color="#000000">text</font> <font color="#4000C0">=</font> <font color="#000000">text</font> <font color="#4000C0">+</font> <font color="#008000">'\n\nContents of $LAUNCHSCRIPT:\n'</font>
            <font color="#C00000">for</font> <font color="#000000">line</font> <font color="#C00000">in</font> <font color="#000000">lines</font><font color="#4000C0">:</font>
                <font color="#000000">text</font> <font color="#4000C0">=</font> <font color="#000000">text</font> <font color="#4000C0">+</font> <font color="#000000">line</font>
            <font color="#000000">os</font><font color="#4000C0">.</font><font color="#000000">unlink</font><font color="#4000C0">(</font><font color="#000000">filename</font><font color="#4000C0">)</font>
        <font color="#C00000">except</font><font color="#4000C0">:</font>
            <font color="#C00000">pass</font>

    <font color="#C00000">return</font> <font color="#000000">text</font>


<font color="#a02030"># For each launcher</font>
<font color="#000000">i</font> <font color="#4000C0">=</font> <font color="#0080C0">0</font>
<font color="#000000">keys</font> <font color="#4000C0">=</font> <font color="#000000">list</font><font color="#4000C0">(</font><font color="#000000">launch_cases</font><font color="#4000C0">.</font><font color="#000000">keys</font><font color="#4000C0">(</font><font color="#4000C0">)</font><font color="#4000C0">)</font>
<font color="#000000">keys</font><font color="#4000C0">.</font><font color="#000000">sort</font><font color="#4000C0">(</font><font color="#4000C0">)</font>
<font color="#C00000">for</font> <font color="#000000">k</font> <font color="#C00000">in</font> <font color="#000000">keys</font><font color="#4000C0">:</font>
    <font color="#a02030"># Test the launcher with each debugger.</font>
    <font color="#000000">j</font> <font color="#4000C0">=</font> <font color="#0080C0">0</font>
    <font color="#000000">text</font> <font color="#4000C0">=</font> <font color="#008000">""</font>
    <font color="#C00000">for</font> <font color="#000000">j</font> <font color="#C00000">in</font> <font color="#000000">range</font><font color="#4000C0">(</font><font color="#000000">len</font><font color="#4000C0">(</font><font color="#000000">debuggers</font><font color="#4000C0">)</font><font color="#4000C0">)</font><font color="#4000C0">:</font>
        <font color="#000000">np</font> <font color="#4000C0">=</font> <font color="#4000C0">[</font><font color="#4000C0">]</font>
        <font color="#C00000">if</font> <font color="#C00000">not</font> <font color="#008000">"-np"</font> <font color="#C00000">in</font> <font color="#000000">launch_cases</font><font color="#4000C0">[</font><font color="#000000">k</font><font color="#4000C0">]</font><font color="#4000C0">:</font>
            <font color="#000000">np</font> <font color="#4000C0">=</font> <font color="#4000C0">[</font><font color="#008000">"-np"</font><font color="#4000C0">,</font> <font color="#008000">"8"</font><font color="#4000C0">]</font>
        <font color="#000000">args</font> <font color="#4000C0">=</font> <font color="#4000C0">[</font><font color="#008000">"-engine"</font><font color="#4000C0">,</font> <font color="#008000">"-norun"</font><font color="#4000C0">,</font> <font color="#008000">"engine_par"</font><font color="#4000C0">,</font> <font color="#008000">"-l"</font><font color="#4000C0">,</font> <font color="#000000">k</font><font color="#4000C0">]</font> <font color="#4000C0">+</font> <font color="#000000">np</font> <font color="#4000C0">+</font> <font color="#000000">launch_cases</font><font color="#4000C0">[</font><font color="#000000">k</font><font color="#4000C0">]</font> <font color="#4000C0">+</font> <font color="#4000C0">[</font><font color="#008000">"-host"</font><font color="#4000C0">,</font> <font color="#008000">"127.0.0.1"</font><font color="#4000C0">,</font> <font color="#008000">"-port"</font><font color="#4000C0">,</font> <font color="#008000">"5600"</font><font color="#4000C0">]</font> <font color="#4000C0">+</font> <font color="#000000">debuggers</font><font color="#4000C0">[</font><font color="#000000">j</font><font color="#4000C0">]</font>

        <font color="#a02030"># Come up with a visit command</font>
        <font color="#000000">cmd</font> <font color="#4000C0">=</font> <font color="#008000">""</font>
        <font color="#C00000">for</font> <font color="#000000">a</font> <font color="#C00000">in</font> <font color="#000000">args</font><font color="#4000C0">:</font>
            <font color="#C00000">if</font> <font color="#008000">" "</font> <font color="#C00000">in</font> <font color="#000000">a</font><font color="#4000C0">:</font>
                <font color="#000000">cmd</font> <font color="#4000C0">=</font> <font color="#000000">cmd</font> <font color="#4000C0">+</font> <font color="#008000">'"%s" '</font> <font color="#4000C0">%</font> <font color="#000000">a</font>
            <font color="#C00000">else</font><font color="#4000C0">:</font>
                <font color="#000000">cmd</font> <font color="#4000C0">=</font> <font color="#000000">cmd</font> <font color="#4000C0">+</font> <font color="#000000">a</font> <font color="#4000C0">+</font> <font color="#008000">' '</font>

        <font color="#a02030"># Run the launcher and get the output.</font>
        <font color="#000000">visitdir</font> <font color="#4000C0">=</font> <font color="#000000">pjoin</font><font color="#4000C0">(</font><font color="#000000">TestEnv</font><font color="#4000C0">.</font><font color="#000000">params</font><font color="#4000C0">[</font><font color="#008000">"top_dir"</font><font color="#4000C0">]</font><font color="#4000C0">,</font><font color="#008000">"src"</font><font color="#4000C0">)</font>
        <font color="#000000">visittestdir</font> <font color="#4000C0">=</font> <font color="#000000">pjoin</font><font color="#4000C0">(</font><font color="#000000">TestEnv</font><font color="#4000C0">.</font><font color="#000000">params</font><font color="#4000C0">[</font><font color="#008000">"top_dir"</font><font color="#4000C0">]</font><font color="#4000C0">,</font><font color="#008000">"test"</font><font color="#4000C0">)</font>
        <font color="#000000">visit</font> <font color="#4000C0">=</font>  <font color="#000000">visit_bin_path</font><font color="#4000C0">(</font><font color="#008000">"visit"</font><font color="#4000C0">)</font>
        <font color="#000000">output</font> <font color="#4000C0">=</font> <font color="#000000">FormatLauncherOutput</font><font color="#4000C0">(</font><font color="#000000">GetLauncherCommand</font><font color="#4000C0">(</font><font color="#4000C0">[</font><font color="#000000">visit</font><font color="#4000C0">]</font> <font color="#4000C0">+</font> <font color="#000000">args</font><font color="#4000C0">)</font><font color="#4000C0">)</font>
        <font color="#a02030"># filter the run dir, since there are multiple variants for nightly tests</font>
        <font color="#a02030"># (serial, par, etc)</font>
        <font color="#000000">output</font> <font color="#4000C0">=</font> <font color="#000000">FilterLauncherOutput</font><font color="#4000C0">(</font><font color="#000000">output</font><font color="#4000C0">,</font> <font color="#4000C0">{</font><font color="#000000">TestEnv</font><font color="#4000C0">.</font><font color="#000000">params</font><font color="#4000C0">[</font><font color="#008000">"run_dir"</font><font color="#4000C0">]</font><font color="#4000C0">:</font> <font color="#008000">"$VISIT_TEST_DIR"</font><font color="#4000C0">}</font><font color="#4000C0">)</font>
        <font color="#000000">output</font> <font color="#4000C0">=</font> <font color="#000000">FilterLauncherOutput</font><font color="#4000C0">(</font><font color="#000000">output</font><font color="#4000C0">,</font> <font color="#4000C0">{</font><font color="#000000">TestEnv</font><font color="#4000C0">.</font><font color="#000000">params</font><font color="#4000C0">[</font><font color="#008000">"result_dir"</font><font color="#4000C0">]</font> <font color="#4000C0">:</font> <font color="#008000">"$VISIT_TEST_DIR"</font><font color="#4000C0">}</font><font color="#4000C0">)</font>
        <font color="#a02030"># Filter out visitdir and some related directories.</font>
        <font color="#000000">output</font> <font color="#4000C0">=</font> <font color="#000000">FilterLauncherOutput</font><font color="#4000C0">(</font><font color="#000000">output</font><font color="#4000C0">,</font> <font color="#4000C0">{</font><font color="#000000">visit_bin_path</font><font color="#4000C0">(</font><font color="#4000C0">)</font> <font color="#4000C0">:</font> <font color="#008000">"$VISIT_EXE_DIR"</font><font color="#4000C0">}</font><font color="#4000C0">)</font>
        <font color="#000000">output</font> <font color="#4000C0">=</font> <font color="#000000">FilterLauncherOutput</font><font color="#4000C0">(</font><font color="#000000">output</font><font color="#4000C0">,</font> <font color="#4000C0">{</font><font color="#000000">visit_bin_path</font><font color="#4000C0">(</font><font color="#008000">".."</font><font color="#4000C0">,</font><font color="#008000">"exe"</font><font color="#4000C0">)</font> <font color="#4000C0">:</font> <font color="#008000">"$VISIT_EXE_DIR"</font><font color="#4000C0">}</font><font color="#4000C0">)</font>
        <font color="#000000">output</font> <font color="#4000C0">=</font> <font color="#000000">FilterLauncherOutput</font><font color="#4000C0">(</font><font color="#000000">output</font><font color="#4000C0">,</font> <font color="#4000C0">{</font><font color="#000000">visittestdir</font> <font color="#4000C0">:</font> <font color="#008000">"$VISIT_TEST_DIR"</font><font color="#4000C0">}</font><font color="#4000C0">)</font>
        <font color="#000000">output</font> <font color="#4000C0">=</font> <font color="#000000">FilterLauncherOutput</font><font color="#4000C0">(</font><font color="#000000">output</font><font color="#4000C0">,</font> <font color="#4000C0">{</font><font color="#000000">visit_bin_path</font><font color="#4000C0">(</font><font color="#008000">".."</font><font color="#4000C0">)</font> <font color="#4000C0">:</font> <font color="#008000">"$VISITDIR"</font><font color="#4000C0">}</font><font color="#4000C0">)</font>
        <font color="#000000">output</font> <font color="#4000C0">=</font> <font color="#000000">FilterLauncherOutput</font><font color="#4000C0">(</font><font color="#000000">output</font><font color="#4000C0">,</font> <font color="#4000C0">{</font><font color="#000000">visitdir</font> <font color="#4000C0">:</font> <font color="#008000">"$VISITDIR"</font><font color="#4000C0">}</font><font color="#4000C0">)</font>
        <font color="#a02030"># special case filter to resolve csh vs bash env differences</font>
        <font color="#000000">bash_case</font>   <font color="#4000C0">=</font> <font color="#008000">"ulimit -c 0 ;"</font>
        <font color="#000000">bash_case</font>  <font color="#4000C0">+=</font> <font color="#008000">" LIBPATH=$VISITDIR/lib ;"</font>
        <font color="#000000">bash_case</font>  <font color="#4000C0">+=</font> <font color="#008000">" export LIBPATH ;"</font>
        <font color="#000000">bash_case</font>  <font color="#4000C0">+=</font> <font color="#008000">" LD_LIBRARY_PATH=$VISITDIR/lib ;"</font>
        <font color="#000000">bash_case</font>  <font color="#4000C0">+=</font> <font color="#008000">" export LD_LIBRARY_PATH"</font>

        <font color="#000000">csh_case</font>  <font color="#4000C0">=</font> <font color="#008000">"limit coredumpsize 0 ;"</font>
        <font color="#000000">csh_case</font> <font color="#4000C0">+=</font> <font color="#008000">" setenv LIBPATH $VISITDIR/lib ;"</font>
        <font color="#000000">csh_case</font> <font color="#4000C0">+=</font> <font color="#008000">" setenv LD_LIBRARY_PATH $VISITDIR/lib"</font>
        <font color="#000000">shell_filter</font> <font color="#4000C0">=</font> <font color="#4000C0">{</font><font color="#000000">bash_case</font> <font color="#4000C0">:</font> <font color="#000000">csh_case</font><font color="#4000C0">}</font>
        <font color="#000000">output</font> <font color="#4000C0">=</font> <font color="#000000">FilterLauncherOutput</font><font color="#4000C0">(</font><font color="#000000">output</font><font color="#4000C0">,</font> <font color="#000000">shell_filter</font><font color="#4000C0">)</font>
        <font color="#a02030"># Filter out $HOME.</font>
        <font color="#C00000">try</font><font color="#4000C0">:</font>
            <font color="#000000">output</font> <font color="#4000C0">=</font> <font color="#000000">FilterLauncherOutput</font><font color="#4000C0">(</font><font color="#000000">output</font><font color="#4000C0">,</font> <font color="#4000C0">{</font><font color="#000000">os</font><font color="#4000C0">.</font><font color="#000000">environ</font><font color="#4000C0">[</font><font color="#008000">"HOME"</font><font color="#4000C0">]</font> <font color="#4000C0">:</font> <font color="#008000">"$HOME"</font><font color="#4000C0">}</font><font color="#4000C0">)</font>
        <font color="#C00000">except</font><font color="#4000C0">:</font>
            <font color="#C00000">pass</font>

        <font color="#000000">cdcmd</font> <font color="#4000C0">=</font> <font color="#008000">"cd $VISIT_TEST_DIR"</font>

        <font color="#a02030"># Filter out some other stuff.</font>
        <font color="#000000">replacements</font> <font color="#4000C0">=</font> <font color="#4000C0">{</font><font color="#000000">getpass</font><font color="#4000C0">.</font><font color="#000000">getuser</font><font color="#4000C0">(</font><font color="#4000C0">)</font> <font color="#4000C0">:</font> <font color="#008000">"$USER"</font><font color="#4000C0">,</font>
                        <font color="#000000">Version</font><font color="#4000C0">(</font><font color="#4000C0">)</font>         <font color="#4000C0">:</font> <font color="#008000">"$VERSION"</font><font color="#4000C0">,</font>
                        <font color="#008000">"linux-intel"</font>     <font color="#4000C0">:</font> <font color="#008000">"$PLATFORM"</font><font color="#4000C0">,</font>
                        <font color="#008000">"linux-x86_64"</font>    <font color="#4000C0">:</font> <font color="#008000">"$PLATFORM"</font><font color="#4000C0">,</font>
                        <font color="#008000">"darwin-i386"</font>     <font color="#4000C0">:</font> <font color="#008000">"$PLATFORM"</font><font color="#4000C0">,</font>
                        <font color="#008000">"darwin-x86_64"</font>   <font color="#4000C0">:</font> <font color="#008000">"$PLATFORM"</font><font color="#4000C0">}</font>

        <font color="#000000">output</font> <font color="#4000C0">=</font> <font color="#000000">FilterLauncherOutput</font><font color="#4000C0">(</font><font color="#000000">output</font><font color="#4000C0">,</font> <font color="#000000">replacements</font><font color="#4000C0">)</font>

        <font color="#000000">output</font> <font color="#4000C0">=</font> <font color="#000000">FilterHostName</font><font color="#4000C0">(</font><font color="#000000">output</font><font color="#4000C0">)</font>

        <font color="#a02030"># Do the test</font>
        <font color="#000000">text</font> <font color="#4000C0">=</font> <font color="#000000">text</font> <font color="#4000C0">+</font> <font color="#008000">"="</font><font color="#4000C0">*</font><font color="#0080C0">80</font> <font color="#4000C0">+</font> <font color="#008000">"\n"</font>
        <font color="#000000">text</font> <font color="#4000C0">=</font> <font color="#000000">text</font> <font color="#4000C0">+</font> <font color="#008000">"CASE: %s\n\nINPUT: visit %s\n\nRESULTS:\n"</font> <font color="#4000C0">%</font> <font color="#4000C0">(</font><font color="#000000">k</font> <font color="#4000C0">+</font> <font color="#008000">" "</font> <font color="#4000C0">+</font> <font color="#000000">string</font><font color="#4000C0">.</font><font color="#000000">join</font><font color="#4000C0">(</font><font color="#000000">debuggers</font><font color="#4000C0">[</font><font color="#000000">j</font><font color="#4000C0">]</font><font color="#4000C0">)</font><font color="#4000C0">,</font> <font color="#000000">cmd</font><font color="#4000C0">[</font><font color="#4000C0">:</font><font color="#4000C0">-</font><font color="#0080C0">1</font><font color="#4000C0">]</font><font color="#4000C0">)</font>
        <font color="#000000">text</font> <font color="#4000C0">=</font> <font color="#000000">text</font> <font color="#4000C0">+</font> <font color="#000000">output</font> <font color="#4000C0">+</font> <font color="#008000">"\n"</font><font color="#4000C0">*</font><font color="#0080C0">2</font>

    <font color="#000000">name</font> <font color="#4000C0">=</font> <font color="#000000">string</font><font color="#4000C0">.</font><font color="#000000">replace</font><font color="#4000C0">(</font><font color="#000000">k</font><font color="#4000C0">,</font> <font color="#008000">"/"</font><font color="#4000C0">,</font> <font color="#008000">"_"</font><font color="#4000C0">)</font>
    <font color="#000000">TestText</font><font color="#4000C0">(</font><font color="#000000">name</font><font color="#4000C0">,</font> <font color="#000000">text</font><font color="#4000C0">)</font>
    <font color="#000000">i</font> <font color="#4000C0">=</font> <font color="#000000">i</font> <font color="#4000C0">+</font> <font color="#0080C0">1</font>

<font color="#000000">Exit</font><font color="#4000C0">(</font><font color="#4000C0">)</font><font color="#000000"></font></font></pre></body></html>